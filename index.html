<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K60NZLB9SJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-K60NZLB9SJ');
</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gale√≥n de Manila - Archivo Digital Completo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+DW+Pica&family=Pirata+One&display=swap" rel="stylesheet">

<style>
        :root { 
        --azul-p: #1b2631; 
        --pergamino: #fdf5e6; 
        --oro: #b2945d; 
        --tinta: #1a1a1a; 
        --verde-sello: #1e8449;
    }

    body, html { 
        margin: 0; padding: 0; 
        height: 100%; width: 100%; 
        font-family: 'IM Fell DW Pica', serif; 
        background: var(--azul-p); 
        overflow: hidden; 
    }

        #menu-roles { 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        padding: 25px; 
        height: 100vh; 
        box-sizing: border-box; 
        justify-content: center; 
        background: radial-gradient(circle, #2e4053, #1b2631); 
        position: absolute; 
        width: 100%; 
        z-index: 3000; 
    }

    .tarjeta-rol { 
        background: var(--pergamino); 
        border: 4px double var(--oro); 
        padding: 15px; 
        text-align: center; 
        border-radius: 12px; 
        box-shadow: 0 8px 20px rgba(0,0,0,0.5); 
        cursor: pointer; 
        transition: transform 0.2s;
    }

    .tarjeta-rol:hover { transform: scale(1.02); }

    .tarjeta-rol h2 { 
        font-family: 'Pirata One', cursive; 
        margin: 0; 
        color: var(--azul-p); 
        font-size: 1.8rem; 
    }

 
    #map { 
        height: 100vh; 
        width: 100%; 
        position: absolute; 
        top: 0; 
        z-index: 1; 
        background: #aad3df; 
    }

        #panel-datos { 
        position: absolute; 
        bottom: 0px; 
        width: 100%; 
        left: 0%; 
        height: 45vh; 
        background: var(--pergamino); 
        border: 4px solid var(--oro); 
        border-radius: 20px; 
        z-index: 2000; 
        display: none; 
        flex-direction: column; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
    }

    .contenido-scroll { padding: 0 20px 20px 20px; overflow-y: auto; flex-grow: 1; }

    /* 5. ELEMENTOS DE BIT√ÅCORA */
    .bitacora { margin-top: 20px; border-top: 2px dashed var(--oro); padding-top: 15px; }
    
    .input-estilo { 
        width: 100%; padding: 12px; margin: 8px 0; 
        border: 1.5px solid var(--oro); border-radius: 8px; 
        box-sizing: border-box; font-family: inherit; 
    }

    .btn-file { 
        background: #546e7a; color: white; width: 100%; padding: 15px; 
        border: none; border-radius: 10px; font-family: 'Pirata One'; 
        font-size: 1.2rem; margin-bottom: 10px; cursor: pointer; 
    }

    .btn-enviar { 
        background: var(--verde-sello); color: white; border: none; 
        width: 100%; padding: 18px; border-radius: 12px; 
        font-family: 'Pirata One'; font-size: 1.4rem; cursor: pointer;
        box-shadow: 0 4px 12px rgba(30, 132, 73, 0.4);
    }

    .btn-accion { 
        background: var(--azul-p); color: white; width: 100%; padding: 15px; 
        border: none; border-radius: 10px; font-family: 'Pirata One'; 
        font-size: 1.3rem; margin-top: 10px; display: none; 
    }

    .btn-accion:disabled {
        background-color: #95a5a6 !important;
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* 6. MODALES Y BIT√ÅCORA FLOTANTE */
    .btn-bitacora-flotante {
        position: fixed !important; top: 20px !important; right: 20px !important;
        background-color: #5dade2 !important; color: white !important;
        padding: 12px 20px !important; border-radius: 30px !important;
        z-index: 999999 !important; border: 2px solid white !important;
        font-family: 'Pirata One', cursive; cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4); display: none;
    }

    #modal-bitacora {
        display: none; position: fixed; z-index: 1000000;
        left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8);
    }

    .cerrar-modal {
        position: absolute; right: 20px; top: 15px;
        font-size: 35px; color: #78281f; font-weight: bold; cursor: pointer;
    }

    /* 7. PANTALLA FINAL (Animaci√≥n y Textura Papyrus) */
    #pantalla-final {
        background-image: url('https://www.transparenttextures.com/patterns/papyrus.png');
        background-color: rgba(0,0,0,0.95);
    }

    #pantalla-final > div {
        animation: aparecerFinal 1.2s ease-out;
    }

    @keyframes aparecerFinal {
        from { opacity: 0; transform: scale(0.8) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    #status-archivo { color: var(--verde-sello); font-weight: bold; text-align: center; margin-bottom: 10px; }
/* Dise√±o de la C√°psula de Sala */
#sala-tag {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 50px; 
    font-weight: bold;
    font-family: 'Pirata One', cursive; 
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 1rem;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2); 
    transition: all 0.4s ease; 
    margin-bottom: 15px;
    border: 2px solid rgba(255,255,255,0.2); 
}

#info-dato {
    font-size: 1.2rem;       
    line-height: 1.6;           color: var(--tinta);
    margin-bottom: 15px;
    text-align: justify;     
}


#info-pregunta {
    font-size: 1.15rem;      
    font-weight: bold;       
    color: #1b2631;          
    font-style: italic;      
    border-left: 3px solid var(--oro); 
    padding-left: 10px;
}


#nombre-hito {
    font-size: 2rem;         /* Bastante grande para que sea lo primero que lean */
    font-family: 'Pirata One', cursive;
    color: var(--azul-p);
    margin-top: 5px;
}
</style>
<body>
    <button id="btn-bitacora-global" onclick="abrirBitacoraCompartida()" class="btn-bitacora-flotante" style="display: none;">
        üìú BIT√ÅCORA DEL GREMIO
    </button>

    <div id="menu-roles" style="display: flex; flex-direction: column; align-items: center; overflow-y: auto; padding-top: 20px;">
        <div style="text-align: center; width: 100%; margin-top: 109px; margin-bottom: 0px; padding: 10px 0;">
            <img src="https://www.sanildefonso.org.mx/expos/somospacifico/images/logo_txt.png" 
                 alt="Somos Pac√≠fico" 
                 style="width: 50%; max-width: 260px; height: auto; filter: brightness(0) invert(1); display: inline-block;">
        </div>

        <div class="tarjeta-rol" style="margin-top: -10px !important; width: 90%;" onclick="accesoRol('Comerciante')">
            <h2>Comerciante</h2>
            <p>Acapulco ‚Üí Manila</p>
        </div>
        <div class="tarjeta-rol" style="width: 90%;" onclick="accesoRol('Cart√≥grafo')"><h2>Cart√≥grafo</h2><p>Acapulco ‚Üí Manila</p></div>
        <div class="tarjeta-rol" style="width: 90%;" onclick="accesoRol('Navegante')"><h2>Navegante</h2><p>Manila ‚Üí Acapulco</p></div>
        <div class="tarjeta-rol" style="width: 90%;" onclick="accesoRol('Artesano')"><h2>Artesano</h2><p>Manila ‚Üí Acapulco</p></div>

        <div style="text-align: center; margin-top: 30px; padding-bottom: 20px; opacity: 0.8;">
            <img src="" 
                 style="max-width: 110px; height: auto; filter: brightness(0) invert(1);">
        </div>
    </div>

    <div id="map"></div>

    <div id="panel-datos" style="display: none;">
        <div class="tirador"></div>
        <div class="contenido-scroll">
            <div class="header-sala">
                <span id="rol-nombre" style="background: var(--azul-p); color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.75rem;">ROL</span>
                <span id="sala-tag" style="font-weight: bold; color: var(--azul-p);">SALA 1/15</span>
                <span id="id-viajero-display" class="id-tag"></span>
            </div>

            <div class="card-historia">
                <h3 id="nombre-hito">Hito</h3>
                <p id="info-dato">Dato hist√≥rico...</p>
                <p id="info-pregunta" class="pregunta-box">Pregunta did√°ctica...</p>
            </div>

            <button id="btn-next" class="btn-accion" onclick="siguienteSala()" style="display: none;">Siguiente Sala ‚Üí</button>

            <div id="bitacora-container">
                <div class="bitacora">
                    <textarea id="texto-bitacora" class="input-estilo" placeholder="Escribe tu hallazgo..."></textarea>
                    <div id="status-archivo"></div> 
                    
                    <button type="button" class="btn-file" onclick="document.getElementById('archivo-oculto').click()">
                        üì∑ Pulsa para tomar una foto
                    </button>
                <input type="file" id="archivo-oculto" 
       accept="image/*" 
       capture="camera" 
       style="display: none;" 
       onchange="actualizarStatusArchivo()">
                    
                    <button onclick="enviarReporte()" class="btn-enviar">
                        üì© click para continuar y espera confirmaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-bitacora" style="display: none; position: fixed; z-index: 10000000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center;">
        <div style="background: #fdf5e6; padding: 20px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 3px double #b2945d;">
            <span onclick="document.getElementById('modal-bitacora').style.display='none'" style="float: right; cursor: pointer; font-size: 30px; font-weight: bold;">&times;</span>
            <h2 style="font-family: 'Pirata One'; color: #78281f; text-align: center;">Memorias de Navegantes</h2>
            <div id="lista-comentarios-modal"></div>
        </div>
    </div>

    <div id="pantalla-final" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 20000000; justify-content: center; align-items: center; flex-direction: column;">
        <div style="text-align: center; border: 5px double #b2945d; background: #fdf5e6; padding: 40px; border-radius: 15px; max-width: 90%; width: 500px; box-shadow: 0 0 50px rgba(178, 148, 93, 0.5);">
            <h1 style="font-family: 'Pirata One', serif; font-size: 3rem; color: #78281f; margin-top: 0;">¬°EXPEDICI√ìN COMPLETADA!</h1>
            <hr style="border: 1px solid #b2945d; width: 80%; margin: 20px auto;">
            <p style="font-size: 1.2rem; line-height: 1.6; color: #1b2631;">
                Honorable <span id="final-rol" style="font-weight: bold; color: #78281f;"></span>, <br><br>
                Tus hallazgos han sido sellados en el <strong>Archivo del Pac√≠fico</strong>. 
                Gracias a tu pericia, la ruta permanece viva.
            </p>
            <div style="background: #eeeae0; padding: 15px; border-radius: 10px; margin: 25px 0; border: 1px dashed #78281f;">
                <p style="margin: 0; font-size: 0.9rem; color: #555;">ID DE VIAJERO:</p>
                <h2 id="final-id" style="margin: 5px 0; letter-spacing: 3px; color: #1b2631;"></h2>
            </div>
            <button onclick="location.reload()" style="background: #1b2631; color: white; padding: 15px 40px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold;">
                INICIAR NUEVA TRAVES√çA
            </button>
        </div>
    </div>

    <div id="contenedor-logo-mapa" style="position: fixed; top: 20px; left: 20px; z-index: 5000; pointer-events: none; display: none;">
    <img src="https://www.sanildefonso.org.mx/expos/somospacifico/images/logo_txt.png" 
         style="width: 140px; filter: brightness(0) invert(1); drop-shadow: 0 2px 4px rgba(0,0,0,0.5);">
</div>
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 30000000; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center;">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #b2945d; border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite; margin-bottom: 20px;"></div>
    <h2 style="font-family: 'Pirata One'; font-size: 2rem;">SELLANDO REPORTE...</h2>
    <p style="padding: 0 20px;">Tu evidencia est√° viajando por el Pac√≠fico.<br>Por favor, no cierres la ventana.</p>
</div>

<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</body>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. CONFIGURACI√ìN GLOBAL Y SEGURIDAD ---
    let viajeroID = "VIAJERO-" + Math.floor(1000 + Math.random() * 9000);
   var map; // Usar var asegura que todas las funciones puedan mover el mapa.
    let salaActual = 1;
    let rolActivo = "";
    let rutaActual = [];

    const LLAVES_ACCESO = {
        "Comerciante": "Seda",
        "Cart√≥grafo": "Mapa",
        "Navegante": "Vela",
        "Artesano": "Taller"
    };

    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwMNAn0fcQogSy6-qiZGUYPUfcIr57tgPUV6icfrvmlglUz1IAbVd2rvNN3hsqyVVen/exec"; 

    
 const rutaBase = [
    { n: "Puerto de Manila", lat: 14.59, lng: 120.98 },
    { n: "Estrecho de San Bernardino", lat: 12.58, lng: 124.28 },
    { n: "Mar de Filipinas", lat: 15.0, lng: 132.0 },
    { n: "Islas Marianas (Guam)", lat: 13.44, lng: 144.79 },
    { n: "Pac√≠fico Norte", lat: 30.0, lng: 160.0 },
    { n: "Corriente de Kuroshio", lat: 38.0, lng: 175.0 },
    { n: "Meridiano 180", lat: 40.0, lng: 180.0 }, 
    { n: "Alta Mar Central", lat: 38.0, lng: -165.0 }, 
    { n: "Zona de Albatros", lat: 35.0, lng: -145.0 },
    { n: "Costa de California", lat: 34.0, lng: -120.0 },
    { n: "Baja California", lat: 24.0, lng: -112.0 },
    { n: "Mar de Cort√©s", lat: 22.0, lng: -108.0 },
    { n: "Cabo Corrientes", lat: 20.4, lng: -105.6 },
    { n: "Costa de Michoac√°n", lat: 18.5, lng: -103.0 },
    { n: "Puerto de Acapulco", lat: 16.86, lng: -99.89 }
];

    
    const baseDeDatos = {
        "Navegante": [
            { n: "Puerto de Manila", d: `La biblioteca de los tr√≥picos presenta una colecci√≥n de obras sobre Bali, destacando su papel clave en el arte del siglo XX m√°s all√° de su imagen de para√≠so tropical. A trav√©s de los viajes de Miguel Covarrubias en las d√©cadas de 1920 y 1930, se exploran las afinidades culturales entre Bali y el sur de M√©xico.`, p:`Toma una foto a uno de los mapas proyectados que se ajuste mejor a lo que deseas conocer durante esta nueva aventura` },
            { n: "Estrecho de San Bernardino", d:`Antes de conquistar M√©xico-Tenochtitl√°n, Hern√°n Cort√©s entendi√≥ que el control del agua era clave. Desde su llegada, mand√≥ construir bergantines con materiales de sus propios barcos y, tras la derrota inicial, reorganiz√≥ sus fuerzas con apoyo ind√≠gena para fabricar trece naves que fueron llevadas al Lago de Texcoco. Estas embarcaciones hicieron posible el asedio naval que permiti√≥ avanzar en la conquista de la ciudad.`, p: `Toma una foto que represente dichos enfrentamientos Navales` },
            { n: "Mar de Filipinas", d: `Juan L√≥pez de Velasco (ca. 1530-1598) fue Cronista Mayor de Indias durante el reinado de Felipe II. Intervino en la realizaci√≥n de las topograf√≠as bas√°ndose en 51 preguntas que se realizaban para poder reunir toda una serie de informaci√≥n social, econ√≥mica, geogr√°fica, cultural, de cada uno de los pueblos, poblados, aldeas y ciudades que compon√≠an los dominios del rey.`, p: `Encuentra en la sala ‚ÄúEl Mapa General de √Ämerica el Oc√©ano Pacifico y la parte este de Asia‚Äù de 	Juan L√≤pez de Velasco` },
            { n: "Islas Marianas (Guam)", d: `De los 163 galeones que navegaron la ruta Acapulco‚ÄìManila durante 250 a√±os, s√≥lo cuatro fueron capturados por corsarios.El primer gale√≥n que cay√≥ fue el Santa Ana, de 700 toneladas y construido en Guatemala. En 1587, tomado por sorpresa, dos corsarios ingleses comandados por Thomas Cavendish, cerca de Cabo San Lucas. M√°s de cien a√±os despu√©s, en 1709, el corsario Woodes Rogers intent√≥ capturar varios galeones frente a las costas de California, pero solo logr√≥ quedarse con uno, el Nuestra Se√±ora de la Encarnaci√≥n. Eso, querido navegante, no es suerte, es estrategia.`, p: `Toma un foto de lo m√°s representativo para que el Gale√≥n se defendiera` },
            { n: "Pac√≠fico Norte", d: `Durante 250 a√±os, los galeones de la ruta Acapulco-Manila, transportaron los m√°s diversos productos del archipi√©lago malayo, de Indonesia, Indochina, China, Jap√≥n y la India. Construida de acero en el siglo XVII para asegurar la plata que surcaba los mares.`, p: `Toma un foto del articulo descrito para transportar la plata ` },
            { n: "Corriente de Kuroshio", d: `Con la ruta transpac√≠fica, comerciantes chinos se establecieron en las afueras de Manila, concentrados en un solo edificio llamado pari√°n, cuyo nombre en tagalo significa ‚Äúmercado chino‚Äù. Este mercado estaba ubicado a tiro de ca√±√≥n de las fortificaciones, para vigilar y controlar el comercio`, p: `Encuentra el ‚ÄúArcon Filipino‚Äù y toma una foto de la ilustraci√≥n del Pari√°n` },
            { n: "Meridiano 180", d: `China envi√≥ grandes cantidades de porcelana a Nueva Espa√±a en los galeones de Manila. Las primeras piezas llegaron durante la dinast√≠a Ming (1368‚Äì1644) y, m√°s tarde, la porcelana alcanz√≥ su mayor esplendor art√≠stico con la dinast√≠a Qing (1644‚Äì1912), especialmente en los reinados de Kangxi (1662‚Äì1722) y Qianlong (1735‚Äì1796).`, p: `Usa tu habilidad, navegante, y rastrea en que pieza de porcelana se encuentra el Gale√≥n` },
            { n: "Alta Mar Central", d: `Este producto es de seda bordada al estilo de las mantillas de Manila. Santa Rosa de Lima es la primera santa americana y tuvo una gran devoci√≥n arraigada con la identidad del territorio. La principal carga de los galeones fueron los productos textiles de China e India.`, p: `Usa tu habilidad, navegante, y rastrea la pieza descrita, encuentrala y toma una foto. ` },
            { n: "Zona de Albatros", d: `El naufragio del gale√≥n San Felipe en 1596 provoc√≥ la ira de Toyotomi Hideyoshi y tuvo graves consecuencias. Adem√°s de p√©rdidas econ√≥micas de un mill√≥n y medio de pesos, el suceso deriv√≥ en la crucifixi√≥n de 1597, dejando una lecci√≥n clave sobre los riesgos de la navegaci√≥n.`, p: `¬øC√≥mo alterar√≠a tu desembarco la noticia de los m√°rtires franciscanos para desembarcar en jap√≥n?` },
            { n: "Costa de California", d: `Es un pa√±o de seda originalmente tejido en Cant√≥n, salpicado de coloridos motivos y rematado con flecos. Su nombre se deriva de la capital filipina, desde donde era enviado a Espa√±a a trav√©s de los puertos mexicanos.`, p: `Toma una foto del art√≠culo mencionado, el cual era exportado a trav√©s de puertos Mexicanos.` },
            { n: "Punta de Baja California", d: `Es reconocida por portar el mant√≥n de Manila, un pa√±o de seda originalmente tejido en Cant√≥n, salpicado de coloridos motivos y rematado con flecos. Su nombre se deriva de la capital filipina, desde donde era enviado a Espa√±a a trav√©s de los puertos mexicanos.`, p: `Toma una foto del art√≠culo mencionado, el cual era exportado a trav√©s de puertos Mexicanos ` },
            { n: "Mar de Cort√©s", d: `Con la Independencia de M√©xico, los galeones fueron desapareciendo, entonces tu oficio, su nombre y peculiaridades evolucionaron ahora navegante es usted un Capit√°n de buque. Desde 1765, la Real Armada Espa√±ola abri√≥ rutas directas entre Espa√±a y Manila para crear una alternativa comercial, fortaleciendo el control econ√≥mico y pol√≠tico en Filipinas. La Independencia de M√©xico debilit√≥ la ruta transpac√≠fica y, desde 1815, los viajes del gale√≥n perdieron relevancia progresivamente.`, p: `Navegante, tal vez este sea tu √∫ltimo viaje por el pacifico como lo conoces, ¬øCu√°l ser√≠a la lecci√≥n m√°s importante que la navegaci√≥n te ha dado? ` },
            { n: "Cabo Corrientes", d: `Miguel Covarrubias fue un artista y antrop√≥logo mexicano que, tras viajar a Bali, public√≥ Island of Bali (1937), obra clave para difundir la isla a nivel mundial. En 1940 realiz√≥ murales para la Exposici√≥n del Golden Gate donde se resalt√≥ la diversidad cultural del Pac√≠fico y cuestionaron visiones ex√≥ticas`, p: `Que libro llevar√≠as como parte de tu viaje, elije sabiamente. Toma una foto9` },
            { n: "Costa de Michoac√°n", d: `Apichatpong Weerasethakul, (Tailandia, 1970) es un director, productor y guionista de cine y artista visual tailand√©s. En su obra, la realidad, la fantas√≠a, los sue√±os, las pesadillas y los fantasmas conviven en un mismo lugar que opera seg√∫n sus propias reglas, y que trata de reflejar la vida tal y como la percibimos.`, p: `A trav√©s de tu profesi√≥n ¬øDe qu√© forma podr√≠as retratar la vida como la conoces? ` },
            { n: "Puerto de Acapulco", d: `Reflexi√≥n `, p: `¬øC√≥mo imaginas que los navegantes del ma√±ana se ver√°n a s√≠ mismos dentro de un mundo donde las rutas, el comercio y la comunicaci√≥n est√°n cada vez m√°s conectados?` }
        ],
      "Artesano": [
    { n: "Puerto de Manila", d: `Esta escultura fue encontrada en las inmediaciones de la Acr√≥polis de la ciudad de Xochicalco, Morelos. Se le llama ‚ÄúEl creador‚Äù: un adulto arrodillado sobre su pierna, barbado y con colmillos de jaguar, porta un tocado con el s√≠mbolo del a√±o y tambi√©n orejeras.`, p: `Toma una foto, ¬øCu√°l es la pieza de la que se habla en la descripci√≥n?` },
    { n: "Estrecho de San Bernardino", d: `Autor no identificado: El biombo de la conquista de M√©xico, finales del siglo XVII. √ìleo sobre tela y madera dorada de la Colecci√≥n Museo Nacional de Historia, Castillo de Chapultepec, Secretar√≠a de Cultura-INAH.`, p: `Observa con atenci√≥n el biombo, en √©l busca un detalle que represente las t√©cnicas o atenci√≥n al detalle del artesano que lo fabric√≥ y t√≥male una foto.` },
    { n: "Mar de Filipinas", d: `El molave es un √°rbol nativo del sudeste asi√°tico, cuya madera densa y duradera fue utilizada tanto en la construcci√≥n de casas e iglesias como en los galeones que atravesaban el oc√©ano Pac√≠fico.`, p: `De acuerdo a la descripci√≥n, busca en la sala la pieza que describe y toma una foto.` },
    { n: "Islas Marianas (Guam)", d: `Durante m√°s de 250 a√±os, los galeones zarparon una vez al a√±o. Una pieza artesanal no se consideraba terminada hasta sobrevivir la traves√≠a. Muchas obras se perd√≠an por malas t√©cnicas de embalaje o por no considerar el movimiento del barco, lo que oblig√≥ a los artesanos a pensar no solo en la est√©tica, sino en la resistencia f√≠sica del objeto.`, p: `Toma una foto que represente la mercanc√≠a con mayor resistencia.` },
    { n: "Pac√≠fico Norte", d: `Desde el siglo XVI, la plata extra√≠da en minas como Zacatecas, Taxco y San Luis Potos√≠ circul√≥ por Asia en forma del peso de ocho reales. Esta moneda se volvi√≥ tan confiable que incluso fue aceptada en China. Su abundancia impuls√≥ la demanda de objetos artesanales lujosos, altamente decorados, destinados a una √©lite capaz de pagar con plata.`, p: `Toma una foto que represente el objeto m√°s valioso de la sala.` },
    { n: "Corriente de Kuroshio", d: `En la plaza mayor de la Ciudad de M√©xico existi√≥ primero el mercado El Baratillo, destruido por un incendio en 1692, lo que llev√≥ a la construcci√≥n del Pari√°n, un mercado permanente frente a la catedral, terminado en 1703 y ampliado hasta 1720.`, p: `Toma una foto en la pintura que retrata tu oficio como artesano.` },
    { n: "Meridiano 180", d: `China envi√≥ grandes cantidades de porcelana a Nueva Espa√±a en los galeones de Manila. Las primeras piezas llegaron durante la dinast√≠a Ming (1368‚Äì1644) y, m√°s tarde, la porcelana alcanz√≥ su mayor esplendor art√≠stico con la dinast√≠a Qing (1644‚Äì1912).`, p: `Toma una foto de la pieza de mayor dificultad art√≠stica.` },
    { n: "Alta Mar Central", d: `El cristianismo se difundi√≥ a trav√©s del Gale√≥n de Manila mediante im√°genes religiosas producidas y comercializadas en serie. Porcelanas chinas y bordados filipinos se usaron para decorar altares. El marfil fue tallado por artesanos chinos en Manila (sangleyes), creando el estilo hispano-filipino, inspirado en grabados flamencos. El estilo indo-portugu√©s represent√≥ figuras cristianas con posturas similares a las de Buda.`, p: `Mu√©stranos un ejemplo de c√≥mo utilizaste alguno de estos materiales o t√©cnicas para crear arte sacro (religioso).` },
    { n: "Zona de Albatros", d: `Estos guerreros conformaban una clase social privilegiada de guerreros de √©lite en el Jap√≥n antiguo y durante el periodo Edo o Tokugawa (1603-1868). ‚ÄúEdo‚Äù se refiere a Tokio, periodo en que se traslada la capital imperial de Kioto a esta ciudad. Su armadura estaba hecha de l√°mina de hierro y cuero laqueados, textil y detalles en bronce y oro.`, p: `Artesano, de acuerdo a la descripci√≥n menciona el nombre de estos guerreros y toma una foto a su armadura.` },
    { n: "Costa de California", d: `En Filipinas las prendas nacionales, en el caso de las mujeres, se compon√≠an por blusa acompa√±ada de un pa√±uelo sobre los hombros, y una falda larga; estas prendas se confeccionaban con el textil baro't saya.`, p: `Artesano, usa tu ojo refinado y toma una foto de la prenda que representa el uso de este textil (baro't saya).` },
    { n: "Punta de Baja California", d: `Con la Independencia de M√©xico, los galeones fueron desapareciendo; entonces tu oficio, su nombre y peculiaridades evolucionaron. Ahora, querido artesano, es usted un pintor muralista. A lo largo de los casi trescientos a√±os que dur√≥ la ruta, no solo se intercambiaron mercanc√≠as, sino tambi√©n costumbres. Los viajeros del siglo XIX representaron lugares desde una perspectiva rom√°ntica e idealizada.`, p: `Identifica en la sala un art√≠culo de artesan√≠a que representa la mezcla cultural y la visi√≥n ‚Äúrom√°ntica‚Äù de aquellos viajes del Gale√≥n.` },
    { n: "Mar de Cort√©s", d: `En el siglo XX, los movimientos de liberaci√≥n en el sudeste asi√°tico propiciaron que artistas de Filipinas, Indonesia y Malasia se enfrentaran a las convenciones. Victorio Edades, Carlos Botong y otros lanzaron manifiestos reivindicando sus ra√≠ces. Esta actitud desafiante, llamada ‚ÄúTropical‚Äù, permiti√≥ el surgimiento de posibilidades creativas.`, p: `Identifica en la sala un art√≠culo de artesan√≠a que representa la mezcla cultural y la visi√≥n ‚Äúrom√°ntica‚Äù de aquellos viajes del Gale√≥n.` },
    { n: "Cabo Corrientes", d: `Los artistas del sudeste asi√°tico usaron el retrato para representarse de forma aut√©ntica. Al incorporar s√≠mbolos y t√©cnicas ind√≠genas, expresaron identidad, solidaridad y pertenencia, dando forma a una visi√≥n de naci√≥n emergente como proyecto pol√≠tico y cultural compartido.`, p: `Toma una foto al retrato de esta sala que te haga sentir personificado y escribe el por qu√©.` },
    { n: "Costa de Michoac√°n", d: `Apichatpong Weerasethakul, (Tailandia, 1970) es un director, productor y guionista de cine y artista visual tailand√©s. En su obra, la realidad, la fantas√≠a, los sue√±os, las pesadillas y los fantasmas conviven en un mismo lugar que opera seg√∫n sus propias reglas, y que trata de reflejar la vida tal y como la percibimos.`, p: `A trav√©s de tu profesi√≥n ¬øDe qu√© forma podr√≠as retratar la vida como la conoces? ` },
    { n: "Puerto de Acapulco", d: `¬øCrees que en el futuro los mapas dejar√°n de ser solo herramientas t√©cnicas para convertirse tambi√©n en expresiones art√≠sticas?`, p: `¬øQu√© papel tendr√≠an entonces pintores, fot√≥grafos, escultores, etc., en su creaci√≥n?` }
],
       "Cart√≥grafo": [
    { n: "Puerto de Acapulco", d:`Miguel Covarrubias fue un pintor, caricaturista, antrop√≥logo e historiador del arte mexicano. Realiz√≥ varios viajes a Bali, que culminaron en la gu√≠a de viaje por excelencia, Island of Bali, publicada en 1937, que contribuy√≥ a la popularizaci√≥n de la isla como un destino tur√≠stico global. En 1940, Covarrubias cre√≥ una serie de murales para la Exposici√≥n Internacional del Golden Gate en San Francisco, que destacaban la riqueza y complejidad de la vida cultural a lo largo del Pac√≠fico y desafiaban las representaciones ex√≥ticas. Impresos por el artista, son mostrados aqu√≠.`, p: `Dentro de los mapas proyectados encuentra la br√∫jula en alguno de los mapas; con ella gu√≠ate al punto cardinal de tu preferencia, toma una foto de tu hallazgo y escribe como pie de foto qu√© punto cardinal seguiste (Norte, Sur, Este u Oeste).` },
    { n: "Costa de Michoac√°n", d:`El C√≥dice Florentino no solo documenta aspectos culturales, sino tambi√©n descripciones del territorio que ayudaron a la Corona a comprender su organizaci√≥n. Estas representaciones fueron un antecedente clave para el desarrollo de mapas que conectaban el centro de M√©xico con los puertos de Acapulco y Veracruz.`, p:`Encuentra el Biombo de la Conquista. T√≥male una foto a tu detalle favorito y responde: Si este biombo fuera un 'mapa' de la ciudad, ¬øqu√© edificio usar√≠as como punto de referencia para no perderte?`},
    { n: "Cabo Corrientes", d:`Relaci√≥n con la Casa de Contrataci√≥n: Los cart√≥grafos deb√≠an ser examinados y certificados por la Casa de Contrataci√≥n en Sevilla para asegurar que pose√≠an los conocimientos matem√°ticos necesarios.`, p:`Busca el libro ‚ÄúVoyage around the World de George Anson‚Äù y t√≥male una foto.`},
    { n: "Mar de Cort√©s", d:`Los relojes de sol se usaban en la n√°utica como instrumentos para medir la hora y tomar medidas de latitud; es decir, para determinar qu√© tan al norte o sur se encontraban. Los relojes anulares med√≠an el tiempo por la evoluci√≥n de la altura del sol, sol√≠an ser port√°tiles y se ajustaban seg√∫n la √©poca del a√±o. Este ejemplar tiene grabado "Orizaba", por lo que en alg√∫n momento del siglo XVIII se gradu√≥ para medir la hora local.`, p:`Busca el reloj solar que contenga el grabado ‚ÄúOrizaba‚Äù y toma una foto.`},
    { n: "Punta de Baja California", d:`La Ciudad de M√©xico era el eje financiero de la ruta. Aqu√≠, la plata mexicana (reales de a ocho) se convert√≠a en la primera moneda global. Los mapas de los puertos (Acapulco y Veracruz) no estaban aislados: el cart√≥grafo deb√≠a conocer el camino terrestre que los un√≠a para asegurar que la plata llegara a los barcos a tiempo.`, p:`Observa los cuadros de los puertos, ¬øqu√© puerto consideras que cobra mayor importancia y por qu√©?`},
    { n: "Costa de California", d:`El cuadro del Z√≥calo es un ejercicio de cartograf√≠a te√≥rica. El autor utiliz√≥ descripciones para ubicar el Pari√°n y los puestos, demostrando que en el siglo XVIII un mapa pod√≠a ser tan fiel como la informaci√≥n que se enviaba por barco, permitiendo que alguien en Europa ‚Äúviera‚Äù la Ciudad de M√©xico.`, p:`Ub√≠cate dentro de la pintura del Pari√°n; ahora elige un punto de referencia desde el cual trazar√≠as tu mapa y t√≥male una foto.`},
    { n: "Zona de Albatros", d:`La porcelana, clasificada principalmente por su decoraci√≥n, destaca los siguientes tipos: azul y blanco, pol√≠croma, Dehua o Blanc de Chine, Imari, Caf√© au lait, familia rosa y verde, her√°ldica y de decoraci√≥n europea. Por lo general, se fabricaba en los grandes centros urbanos y se decoraba con esmaltes en ciudades costeras como Cant√≥n.`, p:`Toma una foto a la pieza que consideras se puede usar como parte de un mapa.`},
    { n: "Alta Mar Central", d:`El cristianismo, como religi√≥n dominante, viajaba en el Gale√≥n. Las im√°genes de Cristo, la Virgen, el Ni√±o Dios y los Santos fueron reproducidas y comercializadas masivamente en diversos materiales que transmit√≠an riqueza y sofisticaci√≥n. Las porcelanas chinas y los bordados filipinos se utilizaban para embellecer los altares.`, p:`Considerando tu experiencia en dibujo y trazo, toma una foto del objeto en esta sala que consideres representa esas habilidades.`},
    { n: "Meridiano 180", d:`A finales del siglo XVI, los intentos de evangelizar Jap√≥n generaron tensiones que culminaron en la crucifixi√≥n de 26 misioneros y conversos en Nagasaki en 1597. Entre ellos estaba Felipe de las Casas, joven criollo nacido en la Ciudad de M√©xico. Su muerte impact√≥ a la sociedad novohispana y, tras su beatificaci√≥n en 1627, Felipe de Jes√∫s se convirti√≥ en un s√≠mbolo religioso y en patrono de la Ciudad de M√©xico.`, p:`Toma una foto del m√°rtir y patrono de la Ciudad de M√©xico, Felipe de Jes√∫s.`},
    { n: "Corriente de Kuroshio", d:`Palabras cotidianas como 'nagua' llegaron a Filipinas desde Nueva Espa√±a. Este intercambio ling√º√≠stico evidencia el papel del territorio como un ‚Äúpuente‚Äù que conecta materiales y culturas a ambos lados del oc√©ano.`, p:`Si tuvieras la encomienda de llevar alguna de estas piezas a un noble novohispano, ¬øcu√°l elegir√≠as? T√≥male una foto.`},
    { n: "Pac√≠fico Norte", d:`Con la Independencia de M√©xico, los galeones fueron desapareciendo; entonces, se√±or cart√≥grafo, su oficio evolucion√≥ a Ingeniero Cart√≥grafo. El sistema termin√≥ en 1815, justo cuando M√©xico buscaba su soberan√≠a. Los mapas dejaron de ser "Secretos de Estado" de la Corona para convertirse en mapas de una nueva naci√≥n, transformando la cartograf√≠a militar en civil y art√≠stica.`, p:`Escribe una nota dirigida a los antiguos tripulantes del Gale√≥n. Expl√≠cales que, aunque el Gale√≥n ya no navega, la 'ruta' que trazaron sigue viva en el arte y en la identidad de la gente.`},
    { n: "Islas Marianas (Guam)", d:`Como cart√≥grafo, en los murales de Rivera ves reflejada la confirmaci√≥n de tu trabajo: M√©xico no es solo un destino, sino el eje central de un mapa global que t√∫ ayudaste a definir y que el muralismo ahora celebra como identidad.`, p:`Toma una foto de alg√∫n elemento de la sala que te recuerde la importancia de la tierra y de los mapas.`},
    { n: "Mar de Filipinas", d: `Miguel Covarrubias fue un artista y antrop√≥logo mexicano que, tras viajar a Bali, public√≥ Island of Bali (1937), obra clave para difundir la isla a nivel mundial. En 1940 realiz√≥ murales para la exposici√≥n del Golden Gate que resaltaban la diversidad cultural del Pac√≠fico y cuestionaban visiones ex√≥ticas.`, p: `Se√±ala el mapa que consideres toma en cuenta no solo rutas y territorio, sino todo aquello que ha interconectado la ruta del Gale√≥n Acapulco-Manila.` },
    { n: "Estrecho de San Bernardino", d: `Apichatpong Weerasethakul, (Tailandia, 1970) es un director, productor y guionista de cine y artista visual tailand√©s. En su obra, la realidad, la fantas√≠a, los sue√±os, las pesadillas y los fantasmas conviven en un mismo lugar que opera seg√∫n sus propias reglas, y que trata de reflejar la vida tal y como la percibimos.`, p: `A trav√©s de tu profesi√≥n ¬øDe qu√© forma podr√≠as retratar la vida como la conoces? ` },
    { n: "Puerto de Manila", d: `Con la tecnolog√≠a y el uso de la IA,`, p: `¬øCrees que en el futuro los mapas los har√°n solo expertos o tambi√©n personas comunes? ¬øC√≥mo cambiar√≠a eso la manera en que vemos y entendemos el mundo?` }
],
       "Comerciante": [
    { n: "Puerto de Acapulco", d: `El cacao, de origen mexicano, fue un bien de gran valor: adem√°s de consumirse, funcion√≥ como moneda en Mesoam√©rica. Las deidades asociadas a √©l representan su poder econ√≥mico y su papel como uno de los primeros productos agr√≠colas exportados masivamente hacia las islas.`, p:`Busca la pieza que creas que tendr√≠a el valor m√°s alto en el mercado de 'curiosidades' de la √©poca. Toma una fotograf√≠a y escribe como pie de foto: 'Precio estimado:...'`  },
    { n: "Costa de Michoac√°n", d: `El biombo como mercanc√≠a de lujo: Los biombos formaban parte de los objetos m√°s codiciados por los sectores m√°s ricos de la Nueva Espa√±a. La pieza que tienes frente a ti pudo haber sido adquirida por un virrey o un comerciante acaudalado, mostrando c√≥mo el arte tambi√©n fue un negocio altamente rentable.`, p: `¬øCu√°l ser√≠a el m√©todo para resguardar el biombo que usar√≠as si lo tuvieras que llevar al centro de la Ciudad de M√©xico para su venta?` },
    { n: "Cabo Corrientes", d: `Las bit√°coras que ves en la sala registraban legalmente los bienes de lujo autorizados para cruzar el oc√©ano, garantizando un comercio sin competencia ilegal.`, p: `¬øQu√© consideras que ser√≠a una ‚Äúmercanc√≠a legal‚Äù?` },
    { n: "Mar de Cort√©s", d: `El Plano Demostrativo, dedicado por su capit√°n Pedro Antonio de Coss√≠o al virrey de Nueva Espa√±a, documenta el dur√≠simo viaje entre Cavite y Acapulco (1755‚Äì1756), que dur√≥ 204 d√≠as debido a calmas y temporales, causando grandes sufrimientos y numerosas muertes. Su esposa sobrevivi√≥ al trayecto.`, p: `Busca en el plano (manta) los d√≠as que tard√≥ el viaje de este gale√≥n y t√≥male una foto.` },
    { n: "Punta de Baja California", d: `Carga l√≠mite (valor de mercanc√≠a): Exist√≠a un l√≠mite de carga llamada ‚Äúpermisi√≥n‚Äù. En diversas √©pocas, se permiti√≥ la exportaci√≥n de 250,000 monedas desde Manila y el retorno de 500,000 monedas en plata desde Acapulco.`, p: `Identifica la moneda de ocho reales de 1804 y t√≥male una foto.` },
    { n: "Costa de California", d: `El Pari√°n era un mercado especializado en bienes de lujo. Surgido en Manila como espacio para el comercio chino, su modelo fue tan exitoso que se replic√≥ en la Plaza Mayor de la Ciudad de M√©xico. Aqu√≠ se concentraba y controlaba la venta de seda, marfil y porcelana.`, p: `Toma una foto en la pintura de la plaza donde colocar√≠as tu puesto.` },
    { n: "Zona de Albatros", d: `Porcelana de importaci√≥n: Las vajillas de porcelana china fueron uno de los productos m√°s valiosos del comercio transpac√≠fico. Las piezas que ves en la sala no son solo objetos art√≠sticos: eran art√≠culos de alto valor que generaban grandes ganancias al llegar a la Ciudad de M√©xico.`, p: `¬øCu√°les son los principales colores de la porcelana que hay en la sala?` },
    { n: "Alta Mar Central", d: `Las vajillas y objetos de porcelana china fueron mercanc√≠as clave para el consumo en la Nueva Espa√±a. Una virgen de porcelana no era solo una imagen religiosa, sino un objeto de lujo elaborado con t√©cnicas avanzadas de Asia, destinado a satisfacer el gusto de las √©lites novohispas.`, p: `¬øQu√© piezas le vender√≠as a un sacerdote novohispano de las que hay en la sala?` },
    { n: "Meridiano 180", d: `La misi√≥n diplom√°tica del noble samur√°i Hasekura Tsunenaga, conocida como Embajada Keich≈ç, fue una delegaci√≥n japonesa enviada a la Nueva Espa√±a por Date Masamune, daimyo de Sendai, entre 1613 y 1620.`, p: `Describe cu√°l era el objetivo principal de esta misi√≥n.` },
    { n: "Corriente de Kuroshio", d: `El mercado del mestizaje cultural: La conquista de Filipinas dio origen a un intenso mestizaje cultural y social. Los trajes de los mestizos reflejan esta mezcla y revelan una nueva oportunidad comercial: prendas que combinan elegancia europea con materiales asi√°ticos.`, p: `¬øEn qu√© condiciones crees que se deber√≠an transportar las prendas?` },
    { n: "Pac√≠fico Norte", d: `Con la Independencia de M√©xico, los galeones desaparecieron; ahora, comerciante, es usted un empresario. La presencia de Oriente es tangible en la p√≥lvora de los fuegos artificiales, el papel picado que adorna nuestras fiestas y las peleas de gallos.`, p: `Identifica un elemento en la sala que represente este legado comercial en la actualidad.` },
    { n: "Islas Marianas (Guam)", d: `En 1921, Siqueiros publica su manifiesto vinculado a las vanguardias. En paralelo, M√©xico vive la pacificaci√≥n posrevolucionaria, donde la cultura y la educaci√≥n se vuelven claves para reconstruir la naci√≥n y promover nuevos ideales de igualdad.`, p: `Busca en la sala una representaci√≥n de este intercambio comercial/cultural y t√≥male una foto.` },
    { n: "Mar de Filipinas", d: `La Biblioteca de los Tr√≥picos re√∫ne libros, pel√≠culas y pinturas sobre Bali. Durante mucho tiempo retratada como para√≠so tropical, Bali ocupa un lugar central en el arte del siglo XX. Miguel Covarrubias rastre√≥ las afinidades entre este lugar y el sur de M√©xico.`, p: `De acuerdo a tu conocimiento de comerciante, ¬øqu√© libros consideras que ser√≠an los m√°s adecuados para distribuirse en M√©xico? Toma una foto.` },
    { n: "Estrecho de San Bernardino", d: `Apichatpong Weerasethakul, (Tailandia, 1970) es un director, productor y guionista de cine y artista visual tailand√©s. En su obra, la realidad, la fantas√≠a, los sue√±os, las pesadillas y los fantasmas conviven en un mismo lugar que opera seg√∫n sus propias reglas, y que trata de reflejar la vida tal y como la percibimos. `, p: `A trav√©s de tu profesi√≥n ¬øDe qu√© forma podr√≠as retratar la vida como la conoces?` },
    { n: "Puerto de Manila", d: `Reflexi√≥n`, p: `Considerando el auge, la crisis y la reconfiguraci√≥n de las rutas comerciales del Pac√≠fico, ¬øc√≥mo imaginas que los comerciantes del futuro participar√°n en este intercambio global?` }
]
    };
function aplicarColorPorRango(numeroSala) {
    const etiquetaSala = document.getElementById('sala-tag');
    if (!etiquetaSala) return;

    let colorRango;

    if (numeroSala >= 1 && numeroSala <= 3) {
        colorRango = "#e84d10";
    } else if (numeroSala >= 4 && numeroSala <= 10) {
        colorRango = "#0047c2";
    } else if (numeroSala >= 11 && numeroSala <= 15) {
        colorRango = "#7000aa";
    }

        etiquetaSala.style.borderColor = colorRango;
    etiquetaSala.style.color = colorRango;
}
function renderPoint(id, auto = false) {
    const hito = rutaActual[id - 1];
    const info = baseDeDatos[rolActivo][id - 1];

    if (!hito || !info) return;

    
    if (typeof gtag === 'function') {
        gtag('event', 'avance_sala', {
            'numero_sala': id,
            'nombre_hito': hito.n,
            'rol_usuario': rolActivo
        });
    }

    
    map.eachLayer((layer) => {
        if (layer instanceof L.Marker || layer instanceof L.Polyline) {
            map.removeLayer(layer);
        }
    });

    // --- 3. CREAR MARCADOR ---
    const marker = L.marker([hito.lat, hito.lng]).addTo(map);

    // --- 4. EVENTO CLICK DEL MARCADOR ---
    marker.on('click', () => {
        // APLICAR COLOR SEG√öN RANGO
        aplicarColorPorRango(id); 

        // Actualizar textos
        document.getElementById('nombre-hito').innerText = info.n;
        document.getElementById('info-dato').innerText = info.d;
        document.getElementById('info-pregunta').innerText = info.p;
        document.getElementById('sala-tag').innerText = `SALA ${id}/15`;

        // Mostrar zonas de interacci√≥n
        const zonaEscritura = document.querySelector('.area-bitacora'); 
        const zonaCarga = document.querySelector('.upload-container'); 
        if(zonaEscritura) zonaEscritura.style.display = "block";
        if(zonaCarga) zonaCarga.style.display = "block";

        // Configurar bot√≥n de avance
        const btnNext = document.getElementById('btn-next');
        if (btnNext) {
            btnNext.style.display = 'block';
            btnNext.disabled = true;
            btnNext.innerText = "üîí RESPONDE PARA AVANZAR";
            btnNext.style.background = "#b2945d"; 
        }

        document.getElementById('texto-bitacora').value = "";

        // C√°mara
        map.flyTo([hito.lat, hito.lng], 5, { animate: true, duration: 1.5 });
        
        if (window.cargarComentarios) cargarComentarios(info.n);
    });

    
    if (id > 1) {
        const hitoAnterior = rutaActual[id - 2];
        L.polyline(
            [[hitoAnterior.lat, hitoAnterior.lng], [hito.lat, hito.lng]],
            { color: '#1b2631', weight: 3, dashArray: '8, 12', opacity: 0.6 }
        ).addTo(map);
    }

    // --- 6. AUTO-CLICK ---
    if (auto) {
        setTimeout(() => marker.fire('click'), 300);
    }
}
function accesoRol(rol) {
    const pass = prompt(`Ingrese la contrase√±a de acceso para el perfil de ${rol}:`);
    
    if (pass === LLAVES_ACCESO[rol]) {
        // 1. Configuraci√≥n de datos
        rolActivo = rol;
        salaActual = 1;
        rutaActual = (rol === "Cart√≥grafo" || rol === "Comerciante") ? [...rutaBase].reverse() : [...rutaBase];
        
        if (!viajeroID) {
            viajeroID = "VIA-" + Math.floor(Math.random() * 9000 + 1000);
        }

        // 2. Interfaz: Mostrar panel y Textos de Bienvenida (Sala 0)
        document.getElementById('menu-roles').style.display = 'none';
        document.getElementById('panel-datos').style.display = 'flex';
document.getElementById('menu-roles').style.display = 'none';
        document.getElementById('rol-nombre').innerText = rol.toUpperCase();
        document.getElementById('id-viajero-display').innerText = viajeroID;
        

        // Mensajes de Bienvenida
        document.getElementById('nombre-hito').innerText = "¬°BIENVENIDO, " + rol.toUpperCase() + "!";
        document.getElementById('info-dato').innerText = "La traves√≠a est√° a punto de comenzar. El mapa ha sido desplegado para mostrarte la ruta comercial.";
        document.getElementById('info-pregunta').innerText = "INSTRUCCI√ìN: Col√≥quese en el primer marcador que aparece en el mapa para iniciar la misi√≥n.";
        document.getElementById('sala-tag').innerText = "Inicio de Misi√≥n";


const logoMapa = document.getElementById('contenedor-logo-mapa');
        if(logoMapa) logoMapa.style.display = 'block';
        // OCULTAR INTERACCI√ìN (Para que sea una Sala 0 limpia)
        const zonaEscritura = document.querySelector('.area-bitacora'); 
        const zonaCarga = document.querySelector('.upload-container'); 
        if(zonaEscritura) zonaEscritura.style.display = 'none';
        if(zonaCarga) zonaCarga.style.display = 'none';

        const btnNext = document.getElementById('btn-next');
        if (btnNext) btnNext.style.display = 'none';

        if(document.getElementById('btn-bitacora-global')) {
            document.getElementById('btn-bitacora-global').style.display = 'block';
        }

        // 3. Inicializar Mapa
        initMap();

        setTimeout(() => {
            // Buscamos el primer punto de la ruta (Manila o Acapulco)
            const primerHito = rutaActual[0];

            if (map && primerHito) {
                // AGREGAR EL MARCADOR INICIAL (Para que el usuario tenga d√≥nde clickear)
                const markerInicio = L.marker([primerHito.lat, primerHito.lng]).addTo(map);
                
                // Hacemos que este marcador tambi√©n dispare el renderPoint al tocarlo
                markerInicio.on('click', () => {
                    renderPoint(1); 
                });

                console.log("Posicionando en origen para " + rol + ":", primerHito.n);
                
                // Volamos al punto inicial
                map.flyTo([primerHito.lat, primerHito.lng], 5, {
                    animate: true,
                    duration: 2.5
                });
            }
        }, 600);

    } else {
        alert("Contrase√±a incorrecta. El Archivo Real permanece cerrado.");
    }
}
function initMap() {
    // Limpiamos si ya existe
    if (map && map.remove) {
        map.remove();
    }
    
    // Vista inicial oce√°nica
    map = L.map('map', { 
        zoomControl: false,
        worldCopyJump: true 
    }).setView([20, 0], 2);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    
    // Tu efecto est√©tico
    document.getElementById('map').style.filter = "sepia(0.3) hue-rotate(185deg) brightness(0.9)";
    
    // Ajuste t√©cnico de tama√±o
    setTimeout(() => { map.invalidateSize(); }, 400);
    
    // NOTA: Aqu√≠ ya no hay renderPoint(1), por eso ya no sale el cuadro vac√≠o.
}
// --- 1. FUNCI√ìN PARA ENVIAR REPORTE (VALIDACI√ìN FLEXIBLE Y IPHONE) ---
async function enviarReporte() {
    const textoElement = document.getElementById('texto-bitacora');
    const texto = textoElement ? textoElement.value : "";

    // L√≥gica de "Salto de Sala" (C√≥digo secreto)
    if (texto.trim().toUpperCase() === "KNAAN") {
        salaActual = 15; 
        renderPoint(salaActual, true); // El 'true' activa el movimiento autom√°tico
        const btnNext = document.getElementById('btn-next');
        if (btnNext) {
            btnNext.disabled = false;
            btnNext.style.display = "block";
            btnNext.innerText = "üìú FINALIZAR TRAVES√çA";
            btnNext.style.background = "#78281f";
        }
        if (textoElement) textoElement.value = ""; 
        return; 
    }

    const inputArchivo = document.getElementById('archivo-oculto');
    const archivoOriginal = inputArchivo ? inputArchivo.files[0] : null;
    const hitoNombre = baseDeDatos[rolActivo][salaActual - 1].n;

    if (!texto.trim() && !archivoOriginal) {
        alert("Navegante, debes escribir un hallazgo o adjuntar una evidencia para sellar el reporte.");
        return;
    }

    // --- CAMBIO ESTRAT√âGICO: Mostrar estado de carga inmediato ---
    const btnSellar = document.querySelector('button[onclick="enviarReporte()"]');
    if (btnSellar) {
        btnSellar.disabled = true;
        btnSellar.innerText = "‚åõ PROCESANDO EVIDENCIA...";
    }

    let payload = {
        idVisitante: viajeroID,
        rol: rolActivo,
        punto: hitoNombre,
        texto: texto,
        archivoB64: null,
        tipoMime: "image/jpeg", // Forzamos JPEG para m√°xima compatibilidad
        nombreArchivo: archivoOriginal ? "foto_" + Date.now() + ".jpg" : null
    };

    if (archivoOriginal) {
        try {
            // --- COMPRESI√ìN DE IMAGEN ON-THE-FLY ---
            // Esto reduce una foto de 10MB a unos 300KB en milisegundos
            payload.archivoB64 = await comprimirImagen(archivoOriginal);
        } catch (error) {
            console.error("Error comprimiendo:", error);
            alert("La imagen es muy pesada. Intenta con otra o solo con texto.");
            if (btnSellar) {
                btnSellar.disabled = false;
                btnSellar.innerText = "SELLAR REPORTE";
            }
            return;
        }
    }

    // Enviamos el payload ya ligero
    enviarFetch(payload);
}

// --- FUNCI√ìN AUXILIAR DE COMPRESI√ìN (A√±√°dela a tu script) ---
function comprimirImagen(archivo) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(archivo);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1000; // Suficiente para ver bien en el Dashboard
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_WIDTH) {
                        width *= MAX_WIDTH / height;
                        height = MAX_WIDTH;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // 0.7 es la calidad (70%). Reduce el peso dr√°sticamente sin perder detalle visual.
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                resolve(dataUrl);
            };
            img.onerror = reject;
        };
        reader.onerror = reject;
    });
}


function abrirBitacoraCompartida() {
    const modal = document.getElementById('modal-bitacora');
    const lista = document.getElementById('lista-comentarios-modal');
    const hitoElement = document.getElementById('nombre-hito');
    const hitoActual = hitoElement ? hitoElement.innerText : "";

    if (!hitoActual || hitoActual === "Hito") return alert("Selecciona un punto primero.");

    modal.style.display = "block";
    lista.innerHTML = "<p style='text-align:center;'>Buscando bit√°coras de " + rolActivo + "...</p>";

    fetch(APPS_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
        // Filtramos por Punto y Rol
        const filtrados = data.filter(d => d.punto === hitoActual && d.rol === rolActivo);
        
        if (filtrados.length === 0) {
            lista.innerHTML = `<p style='text-align:center; padding:20px;'>Nadie del gremio de <b>${rolActivo}s</b> ha dejado evidencias aqu√≠.</p>`;
            return;
        }

       
        lista.innerHTML = filtrados.map(d => `
            <div class="comentario-item" style="background:white; padding:15px; border-radius:10px; margin-bottom:15px; border-left: 5px solid #5dade2; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <small style="color:#7f8c8d;">ID: ${d.id || 'An√≥nimo'}</small>
                <p style="margin:8px 0; font-size: 1rem; color: #1b2631;">${d.texto || "<i style='color:gray;'>Sin comentario escrito</i>"}</p>
                ${crearElementoMultimedia(d.archivo)}
            </div>
        `).join("");
    })
    .catch(err => {
        console.error("Error al cargar:", err);
        lista.innerHTML = "Error al conectar con el Archivo Real.";
    });
}


function crearElementoMultimedia(url) {
    if (!url || url === "" || url === "null" || url === "undefined") return "";

    const link = url.toLowerCase();
    
    
    const esAudio = link.includes("audio") || 
                    link.endsWith(".m4a") || 
                    link.endsWith(".mp3") || 
                    link.endsWith(".wav") || 
                    link.endsWith(".webm") ||
                    link.includes("uc?export=download");

    if (esAudio) {
       
        return `
            <div style="margin-top:10px; background: #f4f7f7; padding: 12px; border-radius: 8px; border: 1px solid #d5dbdb;">
                <p style="font-size:0.7rem; margin-bottom:8px; color: #78281f; font-weight: bold;">üéôÔ∏è EVIDENCIA SONORA</p>
                <audio controls style="width: 100%; height: 35px;">
                    <source src="${url}" type="audio/mp4">
                    <source src="${url}" type="audio/mpeg">
                    <source src="${url}" type="audio/webm">
                    Tu navegador no soporta la reproducci√≥n de audio.
                </audio>
            </div>
        `;
    } else {
       
        return `
            <div style="margin-top:10px;">
                <img src="${url}" 
                     style="width:100%; border-radius:10px; border: 1px solid #b2945d; display: block;" 
                     onerror="this.style.display='none';">
            </div>
        `;
    }
}

function cerrarBitacora() {
    const modal = document.getElementById('modal-bitacora');
    if(modal) modal.style.display = "none";
}
function cerrarBitacora() {
    const modal = document.getElementById('modal-bitacora');
    if(modal) modal.style.display = "none";
}

function crearElementoMultimedia(url) {
    if (!url || url === "" || url === "null") return "";

    const link = url.toLowerCase();

    
    if (link.includes("audio") || link.endsWith(".m4a") || link.endsWith(".mp3") || link.endsWith(".wav") || link.endsWith(".webm")) {
        return `
            <div style="margin-top:10px; background: #f8f9f9; padding: 10px; border-radius: 8px; border: 1px solid #d6dbdf;">
                <p style="font-size:0.7rem; margin-bottom:5px; color: #78281f; font-weight: bold;">üéôÔ∏è EVIDENCIA DE AUDIO:</p>
                <audio controls style="width: 100%; height: 35px;">
                    <source src="${url}" type="audio/mp4">
                    <source src="${url}" type="audio/mpeg">
                    <source src="${url}" type="audio/webm">
                    <source src="${url}" type="audio/wav">
                    Tu navegador no soporta la reproducci√≥n de audio.
                </audio>
            </div>
        `;
    } 
    // Por defecto, tratar como IMAGEN
    else {
        return `
            <div style="margin-top:10px;">
                <img src="${url}" style="width:100%; border-radius:10px; border: 1px solid #b2945d;">
            </div>
        `;
    }
}

    
   function cargarComentarios(punto) {
    const lista = document.getElementById('lista-comentarios');
    lista.innerHTML = "<em>Buscando en los archivos reales...</em>";
    
    fetch(APPS_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
        const filtrados = data.filter(d => d.punto === punto);
        if (filtrados.length === 0) {
            lista.innerHTML = "<em>Sin hallazgos en este punto todav√≠a.</em>";
            return;
        }

        // Construimos la lista asegurando que el multimedia se procese
        let htmlFinal = "";
        filtrados.forEach(d => {
            htmlFinal += `
                <div class="comentario-item">
                    <strong>${d.rol}:</strong> ${d.texto}
                    ${crearElementoMultimedia(d.archivo)} 
                </div>
            `;
        });
        lista.innerHTML = htmlFinal;
    })
    .catch(err => {
        console.error("Error al cargar:", err);
        lista.innerHTML = "<em>El Archivo Real no responde. Revisa la conexi√≥n.</em>";
    });
}

   function crearElementoMultimedia(url) {
    // Si no hay URL o es el texto por defecto, no pongas nada
    if (!url || url === "Sin archivo" || url.includes("Error") || url.trim() === "") return "";

    // Extraer el ID de Google Drive del enlace
    let idDrive = "";
    if (url.includes("id=")) {
        idDrive = url.split("id=")[1].split("&")[0];
    } else if (url.includes("/d/")) {
        idDrive = url.split("/d/")[1].split("/")[0];
    }

    if (!idDrive) return "";

    // Link para visualizaci√≥n directa
    const directUrl = `https://lh3.googleusercontent.com/d/${idDrive}`;

    // PROTECCI√ìN PARA IMAGEN
    const htmlImagen = `
        <div style="position:relative; user-select:none; margin-top:10px; border:1px solid #ddd; border-radius:8px; overflow:hidden;">
            <img src="${directUrl}" style="width:100%; display:block;" oncontextmenu="return false;">
            <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:transparent;"></div>
        </div>`;

    // PROTECCI√ìN PARA AUDIO
    const htmlAudio = `
        <div style="margin-top:10px;">
            <audio controls controlsList="nodownload" oncontextmenu="return false;" style="width:100%;">
                <source src="https://docs.google.com/uc?export=download&id=${idDrive}" type="audio/mpeg">
                Tu navegador no soporta este audio.
            </audio>
        </div>`;

    return (url.toLowerCase().match(/(audio|mp3|wav|m4a|ogg)/)) ? htmlAudio : htmlImagen;
}

    
    function actualizarStatusArchivo() {
        const file = document.getElementById('archivo-oculto').files[0];
        const status = document.getElementById('status-archivo');
        if (file) { status.innerText = `üîó Listo para sellar (‚ö†Ô∏èFotograf√≠a unicamente la pieza, sin rotro de personas): ` + file.name; }
    }

  
function siguienteSala() {
    console.log("Avanzando a sala:", salaActual + 1);

    if (salaActual < 15) {
        salaActual++;
        
        // Guardamos el progreso por si falla la memoria (lo que configuramos antes)
        localStorage.setItem('sala_guardada', salaActual);
        localStorage.setItem('rol_guardado', rolActivo);

        // --- LA CLAVE: Llamamos a renderPoint con 'true' para que se abra solo ---
        renderPoint(salaActual, true);

        // Ocultamos el bot√≥n para que no lo presionen dos veces antes de responder
        const btnNext = document.getElementById('btn-next');
        if (btnNext) btnNext.style.display = 'none';

    } else {
        // Secuencia de fin de viaje (Sala 15)
        const pantallaFinal = document.getElementById('pantalla-final');
        const rDisplay = document.getElementById('final-rol');
        const iDisplay = document.getElementById('final-id');

        if (pantallaFinal && rDisplay && iDisplay) {
            rDisplay.innerText = rolActivo.toUpperCase();
            iDisplay.innerText = viajeroID;
            pantallaFinal.style.display = 'flex';
            document.getElementById('panel-datos').style.display = 'none';
            
            // Limpiamos los datos del tel√©fono al terminar con √©xito
            localStorage.removeItem('rol_guardado');
            localStorage.removeItem('sala_guardada');
        }
    }
}

async function enviarReporte() {
    const textoElement = document.getElementById('texto-bitacora');
    const texto = textoElement ? textoElement.value : "";

    // 1. L√≥gica de "Salto de Sala" (C√≥digo secreto KNAAN)
    if (texto.trim().toUpperCase() === "KNAAN") {
        salaActual = 15; 
        renderPoint(salaActual); 
        const btnNext = document.getElementById('btn-next');
        if (btnNext) {
            btnNext.disabled = false;
            btnNext.style.display = "block";
            btnNext.innerText = "üìú FINALIZAR TRAVES√çA";
            btnNext.style.background = "#78281f";
        }
        if (textoElement) textoElement.value = ""; 
        return; 
    }

    const inputArchivo = document.getElementById('archivo-oculto');
    const archivo = inputArchivo ? inputArchivo.files[0] : null;
    const hitoNombre = baseDeDatos[rolActivo][salaActual - 1].n;

    
    if (!texto.trim() && !archivo) {
        alert("Navegante, debes escribir un hallazgo o adjuntar una evidencia para sellar el reporte.");
        return;
    }

    let payload = {
        idVisitante: viajeroID,
        rol: rolActivo,
        punto: hitoNombre,
        texto: texto,
        archivoB64: null,
        tipoMime: null,
        nombreArchivo: null
    };

    if (archivo) {
        const reader = new FileReader();
        const base64Promise = new Promise((resolve) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(archivo);
        });
        
        payload.archivoB64 = await base64Promise;
        
        let mime = archivo.type;
        let nombreOriginal = archivo.name;

        // Detectamos si es audio por tipo o por extensi√≥n (iPhone)
        if ((mime && mime.includes("audio")) || nombreOriginal.toLowerCase().endsWith('.m4a') || nombreOriginal.toLowerCase().endsWith('.mp3')) {
            // TRUCO: Le ponemos el prefijo "AUDIO_" al nombre para que sea imposible de ignorar
            nombreOriginal = "AUDIO_" + nombreOriginal;
            if (!mime) mime = "audio/mp4"; 
        }
        
        payload.tipoMime = mime;
        payload.nombreArchivo = nombreOriginal;
    }

    // Enviamos al servidor
    enviarFetch(payload);
}

function enviarFetch(payload) {
    const overlay = document.getElementById('loading-overlay');
    const btnNext = document.getElementById('btn-next');
    
    // Mostramos el bloqueo total
    if (overlay) overlay.style.display = 'flex';

    fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(payload)
    })
    .then(() => {
        // Ocultamos el bloqueo
        if (overlay) overlay.style.display = 'none';

        alert("‚úÖ Reporte sellado con √©xito. El camino est√° despejado.");

        if (btnNext) {
            btnNext.disabled = false;
            if (salaActual === 15) {
                btnNext.innerText = "üìú FINALIZAR TRAVES√çA";
                btnNext.style.background = "#78281f";
            } else {
                btnNext.innerText = "SIGUIENTE SALA ‚Üí";
                btnNext.style.background = "var(--oro)"; 
            }
            btnNext.style.display = "block";
        }

        // Limpieza de campos
        document.getElementById('texto-bitacora').value = "";
        document.getElementById('archivo-oculto').value = "";
        if(document.getElementById('status-archivo')) {
            document.getElementById('status-archivo').innerText = "";
        }
    })
    .catch(err => {
        if (overlay) overlay.style.display = 'none';
        console.error(err);
        alert("Error de conexi√≥n. El Archivo Real no pudo recibir tu reporte.");
        if (btnNext) {
            btnNext.disabled = false;
            btnNext.innerText = "REINTENTAR ENV√çO";
        }
    });
}
function regresarAlMenuPrincipal() {
    // 1. Borramos el progreso guardado en el tel√©fono
    localStorage.removeItem('rol_guardado');
    localStorage.removeItem('sala_guardada');
    
    // 2. Redirigimos al inicio para limpiar Analytics
    window.location.href = window.location.pathname; 
}
// Escuchamos todas las interacciones posibles para saber que el usuario sigue ah√≠
window.onload = resetearRelojInactividad;
document.onmousemove = resetearRelojInactividad;
document.onkeypress = resetearRelojInactividad;
document.onclick = resetearRelojInactividad;
document.ontouchstart = resetearRelojInactividad; // Crucial para los m√≥viles (75% de tus usuarios)

</script>




