<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gale√≥n de Manila - Archivo Digital Completo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+DW+Pica&family=Pirata+One&display=swap" rel="stylesheet">

    <style>
       .btn-bitacora-flotante {
    position: fixed !important;
    top: 20px;
    right: 20px;
    background-color: #5dade2 !important; /* Azul claro */
    color: white !important;
    padding: 12px 22px;
    border-radius: 30px;
    border: 2px solid white;
    font-family: 'Pirata One', cursive;
    font-size: 1.1rem;
    z-index: 999999; 
    display: none; /* Se activa tras la contrase√±a */
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
}

    .modal-personalizado {
        display: none;
        position: fixed;
        z-index: 1000000;
        left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8);
    }

    .modal-contenido {
        background: #fdf5e6; /* Color pergamino */
        margin: 10% auto;
        padding: 20px;
        border: 3px solid #b2945d;
        width: 85%;
        max-height: 70vh;
        overflow-y: auto;
        border-radius: 15px;
        position: relative;
    }

    .cerrar-modal {
        position: absolute;
        right: 15px; top: 10px;
        font-size: 35px; color: #78281f; cursor: pointer;
    }
    :root { --azul-p: #1b2631; --pergamino: #fdf5e6; --oro: #b2945d; --tinta: #1a1a1a; }
    body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'IM Fell DW Pica', serif; background: var(--azul-p); overflow: hidden; }

    /* --- MEN√ö DE ROLES --- */
    #menu-roles { display: flex; flex-direction: column; gap: 12px; padding: 25px; height: 100vh; box-sizing: border-box; justify-content: center; background: radial-gradient(circle, #2e4053, #1b2631); position: absolute; width: 100%; z-index: 3000; }
    .tarjeta-rol { background: var(--pergamino); border: 4px double var(--oro); padding: 15px; text-align: center; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); cursor: pointer; }
    .tarjeta-rol h2 { font-family: 'Pirata One', cursive; margin: 0; color: var(--azul-p); font-size: 1.8rem; }

    /* --- MAPA --- */
    #map { height: 100vh; width: 100%; position: absolute; top: 0; z-index: 1; background: #aad3df; }

    /* --- PANEL UX (ELEVADO PARA EVITAR MARCA DE AGUA) --- */
    #panel-datos { 
        position: absolute; 
        bottom: 90px; /* üëà Elevado para saltar el logo del host */
        width: 94%; 
        left: 3%; 
        height: 48vh; 
        background: var(--pergamino); 
        border: 3px solid var(--oro); 
        border-radius: 20px; 
        z-index: 2000; 
        display: none; 
        flex-direction: column; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.4); 
    }

    .contenido-scroll { padding: 0 20px 20px 20px; overflow-y: auto; flex-grow: 1; }

    /* --- BOTONES DE LA BIT√ÅCORA (RECUPERANDO FORMATO) --- */
    .bitacora { margin-top: 20px; border-top: 2px dashed var(--oro); padding-top: 15px; }
    
    .input-estilo { width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid var(--oro); border-radius: 8px; box-sizing: border-box; font-family: inherit; }

    /* Bot√≥n Adjuntar (üì∑ / üéôÔ∏è) */
    .btn-file { 
        background: #546e7a; 
        color: white; 
        width: 100%; 
        padding: 15px; 
        border: none; 
        border-radius: 10px; 
        font-family: 'Pirata One'; 
        font-size: 1.2rem;
        margin-bottom: 10px; 
        cursor: pointer; 
        box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    /* Bot√≥n Sellar (Verde y Vistoso) */
    .btn-enviar { 
        background: #1e8449; 
        color: white; 
        border: none; 
        width: 100%; 
        padding: 18px; 
        border-radius: 12px; 
        font-family: 'Pirata One'; 
        font-size: 1.4rem; 
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(30, 132, 73, 0.4);
        cursor: pointer;
    }

    /* Bot√≥n Siguiente Sala (Dorado) */
    .btn-accion { 
        background: var(--azul-p); 
        color: white; 
        width: 100%; 
        padding: 15px; 
        border: none; 
        border-radius: 10px; 
        font-family: 'Pirata One'; 
        font-size: 1.3rem; 
        margin-top: 10px; 
        display: none; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #status-archivo { color: #1e8449; font-weight: bold; text-align: center; margin-bottom: 10px; font-size: 0.9rem; }
/* Bot√≥n de Bit√°cora Compartida - Posici√≥n Superior */
.btn-bitacora-flotante {
    position: fixed !important; /* Fuerza la posici√≥n */
    top: 20px !important;
    right: 20px !important;
    background-color: #5dade2 !important; /* El azul claro que pediste */
    color: white !important;
    padding: 12px 20px !important;
    border-radius: 30px !important;
    z-index: 999999 !important; /* El n√∫mero m√°s alto posible */
    display: none; /* Se mantiene oculto hasta que entres con contrase√±a */
    border: 2px solid white !important;
    font-family: 'Pirata One', cursive;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    display: none;      /* Se activa solo cuando entras a un rol */
    transition: transform 0.2s, background 0.3s;
}

.btn-bitacora-flotante:hover {
    background: #3498db;
    transform: scale(1.05);
}

/* Ajuste al Modal para que la 'X' sea muy visible */
.cerrar-modal {
    position: absolute;
    right: 20px;
    top: 15px;
    font-size: 35px;
    color: #78281f;
    font-weight: bold;
    cursor: pointer;
    z-index: 5001;
}
</style>
<body>
    <button id="btn-bitacora-global" onclick="abrirBitacoraCompartida()" class="btn-bitacora-flotante">
        üìú BIT√ÅCORA DEL GREMIO
    </button>
    
    </body>

    <div id="menu-roles">
        <h1 style="color: var(--pergamino); text-align: center; font-family: 'Pirata One'; font-size: 2.2rem; margin-bottom: 10px;">Archivo del Pac√≠fico</h1>
        <div class="tarjeta-rol" onclick="accesoRol('Comerciante')"><h2>Comerciante</h2><p>Acapulco ‚Üí Manila</p></div>
        <div class="tarjeta-rol" onclick="accesoRol('Cart√≥grafo')"><h2>Cart√≥grafo</h2><p>Acapulco ‚Üí Manila</p></div>
        <div class="tarjeta-rol" onclick="accesoRol('Navegante')"><h2>Navegante</h2><p>Manila ‚Üí Acapulco</p></div>
        <div class="tarjeta-rol" onclick="accesoRol('Artesano')"><h2>Artesano</h2><p>Manila ‚Üí Acapulco</p></div>
    </div>

    <div id="map"></div>

    <div id="panel-datos">
        <div class="tirador"></div>
        <div class="contenido-scroll">
            <div class="header-sala">
                <span id="rol-nombre" style="background: var(--azul-p); color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.75rem;">ROL</span>
                <span id="sala-tag" style="font-weight: bold; color: var(--azul-p);">SALA 1/15</span>
                <span id="id-viajero-display" class="id-tag"></span>
            </div>

            <div class="card-historia">
                <h3 id="nombre-hito">Hito</h3>
                <p id="info-dato">Dato hist√≥rico...</p>
                <p id="info-pregunta" class="pregunta-box">Pregunta did√°ctica...</p>
            </div>

            <button id="btn-next" class="btn-accion" onclick="siguienteSala()">Siguiente Sala ‚Üí</button>

            <div id="bitacora-container">
                <div class="bitacora">
                    <textarea id="texto-bitacora" class="input-estilo" placeholder="Escribe tu hallazgo..."></textarea>
                    
                    <div id="status-archivo"></div> 
                    
                    <button type="button" class="btn-file" onclick="document.getElementById('archivo-oculto').click()">
                        üì∑ / üéôÔ∏è ADJUNTAR EVIDENCIA
                    </button>
                    <input type="file" id="archivo-oculto" accept="image/*,audio/*" style="display: none;" onchange="actualizarStatusArchivo()">
                    
                    <button onclick="enviarReporte()" class="btn-enviar">
                        üì© SELLAR REPORTE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-bitacora" class="modal-personalizado">
        <div class="modal-contenido">
            <span class="cerrar-modal" onclick="cerrarBitacora()">&times;</span>
            <h2 style="font-family: 'Pirata One'; color: #78281f; text-align: center; margin-top: 0;">Memorias de Navegantes</h2>
            <div id="lista-comentarios-modal">
                </div>
        </div>
    </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. CONFIGURACI√ìN GLOBAL Y SEGURIDAD ---
    const viajeroID = "VIAJERO-" + Math.floor(1000 + Math.random() * 9000);
    let map;
    let salaActual = 1;
    let rolActivo = "";
    let rutaActual = [];

    const LLAVES_ACCESO = {
        "Comerciante": "Seda",
        "Cart√≥grafo": "Br√∫jula",
        "Navegante": "8090",
        "Artesano": "8090"
    };

    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwMNAn0fcQogSy6-qiZGUYPUfcIr57tgPUV6icfrvmlglUz1IAbVd2rvNN3hsqyVVen/exec"; 

    // --- 2. RUTA BAS
    const rutaBase = [
        { n: "Puerto de Manila", c: [14.59, 120.98] },
        { n: "Estrecho de San Bernardino", c: [12.58, 124.28] },
        { n: "Mar de Filipinas", c: [15.0, 132.0] },
        { n: "Islas Marianas (Guam)", c: [13.44, 144.79] },
        { n: "Pac√≠fico Norte", c: [30.0, 160.0] },
        { n: "Corriente de Kuroshio", c: [38.0, 175.0] },
        { n: "Meridiano 180", c: [40.0, 180.0] }, 
        { n: "Alta Mar Central", c: [38.0, 195.0] }, 
        { n: "Zona de Albatros", c: [35.0, 215.0] },
        { n: "Costa de California", c: [34.0, 240.0] },
        { n: "Baja California", c: [24.0, 248.0] },
        { n: "Mar de Cort√©s", c: [22.0, 252.0] },
        { n: "Cabo Corrientes", c: [20.4, 254.4] },
        { n: "Costa de Michoac√°n", c: [18.5, 257.0] },
        { n: "Puerto de Acapulco", c: [16.86, 260.11] }
    ];

    // --- 3. BASE DE DATOS (Contenido del Museo) ---
    const baseDeDatos = {
        "Navegante": [
            { n: "Puerto de Manila", d: "Dato 1", p: "¬øPregunta 1?" },
            { n: "Estrecho de San Bernardino", d: "Dato 2", p: "¬øPregunta 2?" },
            { n: "Mar de Filipinas", d: "Dato 3", p: "¬øPregunta 3?" },
            { n: "Islas Marianas (Guam)", d: "Dato 4", p: "¬øPregunta 4?" },
            { n: "Pac√≠fico Norte", d: "Dato 5", p: "¬øPregunta 5?" },
            { n: "Corriente de Kuroshio", d: "Dato 6", p: "¬øPregunta 6?" },
            { n: "Meridiano 180", d: "Dato 7", p: "¬øPregunta 7?" },
            { n: "Alta Mar Central", d: "Dato 8", p: "¬øPregunta 8?" },
            { n: "Zona de Albatros", d: "Dato 9", p: "¬øPregunta 9?" },
            { n: "Costa de California", d: "Dato 10", p: "¬øPregunta 10?" },
            { n: "Punta de Baja California", d: "Dato 11", p: "¬øPregunta 11?" },
            { n: "Mar de Cort√©s", d: "Dato 12", p: "¬øPregunta 12?" },
            { n: "Cabo Corrientes", d: "Dato 13", p: "¬øPregunta 13?" },
            { n: "Costa de Michoac√°n", d: "Dato 14", p: "¬øPregunta 14?" },
            { n: "Puerto de Acapulco", d: "Dato 15", p: "¬øPregunta 15?" }
        ],
        "Artesano": [
            { n: "Puerto de Manila", d: "Dato 1", p: "¬øPregunta 1?" },
            { n: "Estrecho de San Bernardino", d: "Dato 2", p: "¬øPregunta 2?" },
            { n: "Mar de Filipinas", d: "Dato 3", p: "¬øPregunta 3?" },
            { n: "Islas Marianas (Guam)", d: "Dato 4", p: "¬øPregunta 4?" },
            { n: "Pac√≠fico Norte", d: "Dato 5", p: "¬øPregunta 5?" },
            { n: "Corriente de Kuroshio", d: "Dato 6", p: "¬øPregunta 6?" },
            { n: "Meridiano 180", d: "Dato 7", p: "¬øPregunta 7?" },
            { n: "Alta Mar Central", d: "Dato 8", p: "¬øPregunta 8?" },
            { n: "Zona de Albatros", d: "Dato 9", p: "¬øPregunta 9?" },
            { n: "Costa de California", d: "Dato 10", p: "¬øPregunta 10?" },
            { n: "Punta de Baja California", d: "Dato 11", p: "¬øPregunta 11?" },
            { n: "Mar de Cort√©s", d: "Dato 12", p: "¬øPregunta 12?" },
            { n: "Cabo Corrientes", d: "Dato 13", p: "¬øPregunta 13?" },
            { n: "Costa de Michoac√°n", d: "Dato 14", p: "¬øPregunta 14?" },
            { n: "Puerto de Acapulco", d: "Dato 15", p: "¬øPregunta 15?" }
        ],
        "Cart√≥grafo": [
            { n: "Puerto de Acapulco", d:`El cacao, de origen mexicano, fue un bien de gran valor: adem√°s de consumirse, funcion√≥ como moneda en Mesoam√©rica. Las deidades asociadas a √©l representan su poder econ√≥mico y su papel como uno de los primeros productos agr√≠colas exportados masivamente hacia las islas.`, p: `Busca la pieza que creas que tendr√≠a el valor m√°s alto en el mercado de ‚Äúcuriosidades‚Äù de la √©poca. Toma una fotograf√≠a y escribe como pie de foto: 'Precio estimado:..` },
            { n: "Costa de Michoac√°n", d:`El C√≥dice Florentino no solo documenta aspectos culturales, sino tambi√©n descripciones del territorio que ayudaron a la Corona a comprender su organizaci√≥n. Estas representaciones fueron un antecedente clave para el desarrollo de mapas que conectaban el centro de M√©xico con los puertos de Acapulco y Veracruz.`,p:`Encuentra el Biombo de la Conquista. T√≥male una foto a tu detalle favorito y responde: Si este biombo fuera un 'mapa' de la ciudad, ¬øqu√© edificio usar√≠as como punto de referencia para no perderte?`},
            { n: "Cabo Corrientes",  d:`En 1734, Joseph Gonz√°lez Cabrera Bueno public√≥ en Manila la gu√≠a m√°s importante para cruzar el Pac√≠fico. Sus mapas eran tan precisos que ayudaban a evitar los "bajos" (arrecifes) que pod√≠an hundir el Gale√≥n.`,p:`Busca libro ‚Äúvoyage around the World de George Anson‚Äù y tomale una foto`},
            { n: "Mar de Cort√©s",  d:`El Cart√≥grafo usaba el Reloj Solar y la Calcograf√≠a (mapas impresos en cobre) para calcular la ruta exacta.`,p:`Mira el Reloj Solar. D√≠a 150 en el mar. El sol marca nuestra posici√≥n. Seg√∫n mis c√°lculos, estamos cerca de las Islas Marianas ¬ø Qu√© colocar√≠as en tu bit√°cora de viaje? graba un audio`},
            { n: "Punta de Baja California",  d:`La Ciudad de M√©xico era el eje financiero de la ruta. Aqu√≠, la Plata Mexicana (reales de a ocho) se convert√≠a en la primera moneda global. Los mapas de los puertos (Acapulco y Veracruz) no estaban aislados: el Cart√≥grafo deb√≠a conocer el camino terrestre que los un√≠a para asegurar que la plata llegara a los barcos a tiempo`,p:`Observa los cuadros de los puertos, que puerto consideras que cobra mayor importancia y por qu√©`},
            { n: "Costa de California",  d:`El cuadro del Z√≥calo es un ejercicio de cartograf√≠a te√≥rica. El autor utiliz√≥ descripciones para ubicar el Pari√°n y los puestos, demostrando que en el siglo XVIII, un mapa pod√≠a ser tan fiel como la informaci√≥n que se enviaba por barco, permitiendo que alguien en Europa ‚Äúviera‚Äù la Ciudad de M√©xico.`,p:`Como Cart√≥grafo, ¬øqu√© tan dif√≠cil crees que fue para el autor dibujar estas calles sin haberlas caminado nunca?`},
            { n: "Zona de Albatros",  d:`La palabra "petaca" (que hoy asociamos a algo peque√±o) se usaba originalmente para designar una maleta o cofre hecho de palma tejida donde se transportaba el tabaco y el cacao`,p:`Si tuvieras que usar un emoji para representar el cacao en un mapa ¬øcu√°l usar√≠as?`},
            { n: "Alta Mar Central", d:`Los textos navales de Cabrera Bueno muestran c√≥mo la geograf√≠a y la religi√≥n estaban estrechamente ligadas. En el Estrecho de San Bernardino, donde las corrientes eran extremadamente peligrosas, los navegantes confiaban m√°s en la protecci√≥n de la Virgen de la Gu√≠a que en los mapas para atravesar el archipi√©lago.`,p:`Seg√∫n tu experiencia de trazos y dibujos ¬øC√∫al de estas piezas es m√°s dif√≠cil y por qu√©?`},
            { n: "Meridiano 180", d:`El naufragio del gale√≥n San Felipe en 1596 provoc√≥ la ira de Toyotomi Hideyoshi y tuvo graves consecuencias. Adem√°s de p√©rdidas econ√≥micas de un mill√≥n y medio de pesos, el suceso deriv√≥ en la crucifixi√≥n de 1597, dejando una lecci√≥n clave sobre los riesgos de la navegaci√≥n`,p:`¬øC√≥mo alterar√≠a tu desembarco la noticia de los m√°rtires franciscanos para desembarcar en jap√≥n`},
            { n: "Corriente de Kuroshio",  d:`Palabras cotidianas como el agua llegaron a Filipinas desde Nueva Espa√±a. Este intercambio ling√º√≠stico evidencia el papel del territorio como un ‚Äúpuente‚Äù que conecta materiales y culturas a ambos lados del oc√©ano.`,p:`Si tuvieras la encomienda de llevar alguna de estas piezas a un noble novohispano, ¬øcual elegir√≠as? tomale una foto`},
            { n: "Pac√≠fico Norte",  d:`El sistema termin√≥ en 1815, justo cuando M√©xico buscaba su soberan√≠a. Para tu oficio, esto signific√≥ que los mapas dejaron de ser "Secretos de Estado" de la Corona Espa√±ola para convertirse en los mapas de una nueva naci√≥n, transformando la cartograf√≠a militar en cartograf√≠a civil y art√≠stica.`,p:`Graba una nota de voz dirigida a los antiguos tripulantes del Gale√≥n. Expl√≠cales que, aunque el Gale√≥n ya no navega, la 'ruta' que trazaron sigue viva en el arte y en la identidad de la gente`},
            { n: "Islas Marianas (Guam)",  d:`Como Cart√≥grafo, ves en los murales de Rivera la confirmaci√≥n de tu trabajo: M√©xico no es solo un destino, sino el eje central de un mapa global que t√∫ ayudaste a definir y que el muralismo ahora celebra como identidad.`,p:`Como Cart√≥grafo, ves en los murales de Rivera la confirmaci√≥n de tu trabajo: M√©xico no es solo un destino, sino el eje central de un mapa global que t√∫ ayudaste a definir y que el muralismo ahora celebra como identidad.`},
            { n: "Mar de Filipinas", d: "Proximamente", p: "Proximamente" },
            { n: "Estrecho de San Bernardino", d: "Proximamente 14", p: "¬øProximamente 14?" },
            { n: "Puerto de Manila", d: "Proximamente 15", p: "¬øProximamente 15?" }
        ],
        "Comerciante": [
            { n: "Puerto de Acapulco", d: `El cacao, de origen mexicano, fue un bien de gran valor: adem√°s de consumirse, funcion√≥ como moneda en Mesoam√©rica. Las deidades asociadas a √©l representan su poder econ√≥mico y su papel como uno de los primeros productos agr√≠colas exportados masivamente hacia las islas.`, p:`Busca la pieza que creas que tendr√≠a el valor m√°s alto en el mercado de 'curiosidades' de la √©poca. Toma una fotograf√≠a y escribe como pie de foto: 'Precio estimado:...'`  },
            { n: "Costa de Michoac√°n", d: `El biombo como mercanc√≠a de lujo:Los biombos formaban parte de los objetos m√°s codiciados por los sectores m√°s ricos de la Nueva Espa√±a. La pieza que tienes frente a ti pudo haber sido adquirida por un virrey o un comerciante acaudalado, mostrando c√≥mo el arte tambi√©n fue un negocio altamente rentable.`, p: `¬øCu√°l ser√≠a el m√©todo para resguardar el biombo que usar√≠as si lo tuvieras que llevar al centro de la Ciudad de M√©xico para su venta?` },
            { n: "Cabo Corrientes", d: `Las bit√°coras que ves en la sala registraban legalmente los bienes de lujo autorizados para cruzar el oc√©ano, garantizando un comercio sin competencia ilegal.`, p: `¬øQu√© consideras que ser√≠a una ‚Äúmercanc√≠a legal‚Äù?` },
            { n: "Mar de Cort√©s", d: `El contacto y comercio entre M√©xico y Filipinas se mantuvo durante m√°s de 250 a√±os. La manta que narra un viaje de m√°s de 200 d√≠as simboliza el tiempo de maduraci√≥n de la inversi√≥n: cada d√≠a en el mar incrementan los riesgos, desde el da√±o al casco hasta la humedad que pod√≠a arruinar la carga y reducir las ganancias finales.`, p: `Imagina que llevas meses en El Gale√≥n, que te preocupa m√°s por tus productos, la humedad, el movimiento, el ataque de corsarios o alguna otra cosa que te pudiera hacer perder tu inversi√≥n?Graba un audio` },
            { n: "Punta de Baja California", d: `Carga l√≠mite (valor de mercanc√≠a): Exist√≠a un l√≠mite de carga llamada ‚Äúpermisi√≥n‚Äù en diversas √©pocas, se permitir la exportaci√≥n de 250,000 monedas desde Manila y el retorno de 500,00 monedas en plata desde Acapulco`, p: `¬øQu√© llevar√≠as para vender desde Manila? Graba un audio` },
            { n: "Costa de California", d: `El pari√°n era un mercado especializado en bienes de lujo. Surgido en Manila como espacio para el comercio chino, su modelo fue tan exitoso que se replic√≥ en la Plaza Mayor de la Ciudad de M√©xico, como muestran la maqueta y la pintura. Aqu√≠ se concentraba y controlaba la venta de seda, marfil y porcelana.`, p: `Toma una foto en la pintura de la plaza donde colocarias tu puesto` },
            { n: "Zona de Albatros", d: `Porcelana de importaci√≥n:Las vajillas de porcelana china fueron uno de los productos m√°s valiosos del comercio transpac√≠fico. Las piezas que ves en la sala no son solo objetos art√≠sticos: eran art√≠culos de alto valor que generaban grandes ganancias al llegar a la Ciudad de M√©xico`, p: `¬øCu√°les son los principales colores de la porcelana que hay en la sala?` },
            { n: "Alta Mar Central", d: `Aunque se ten√≠a una ley para poner l√≠mite al cargamento, en la pr√°ctica el valor de los transportado era mucho mayor. Se estima que en el siglo XVIII se llegaba a despachar hasta 2.5 millones de monedas de plata de retorno, superando por mucho el permiso oficial.`, p: `¬øQu√© Piezas le vender√≠as a un sacerdote novohispano, de las que hay en la sala?` },
            { n: "Meridiano 180", d:`El sistema de licencias (Shuinsen):Tras diversos conflictos, el comercio con Jap√≥n qued√≥ restringido a los barcos del sello bermejo, autorizados por el gobierno. Sin este permiso oficial, ninguna mercanc√≠a pod√≠a desembarcar, convirtiendo a Jap√≥n en un mercado cerrado para quienes no contaban con influencia pol√≠tica`, p: `Llevas meses navegando con especias y seda hacia Jap√≥n. Pero al llegar al puerto de Nagasaki, un oficial te detiene. No te pregunta qu√© vendes, sino que te pide ver el Sello Bermejo ¬øQu√© le dir√≠as? graba tu respuesta en un audio` },
            { n: "Corriente de Kuroshio", d: `El mercado del mestizaje cultural:La conquista de Filipinas dio origen a un intenso mestizaje cultural y social. Los trajes de los mestizos reflejan esta mezcla y revelan una nueva oportunidad comercial: prendas que combinan la elegancia europea con materiales asi√°ticos, destinadas a una clase social emergente y con demandas propias.`, p: `¬øEn qu√© condiciones crees que se deber√≠a de transportar las prendas?` },
            { n: "Pac√≠fico Norte", d: `El Gale√≥n fue un sistema que dur√≥ de 1565 a 1815. Como comerciante, este es el dato del "cierre de la empresa" tras 250 a√±os, el modelo de monopolio que te proteg√≠a dej√≥ de ser rentable debido a las guerras de independencia en M√©xico y la presi√≥n de nuevas potencias comerciales.`, p: `¬øQu√© objeto crees que haya sido el m√°s dif√≠cil de conseguir una vez el Gale√≥n dej√≥ de navegar?` },
            { n: "Islas Marianas (Guam)", d: `Las obras de Rivera en esta sala son el producto final de ese mestizaje. Como mercader, entiendes que la riqueza de M√©xico hoy reside en esa mezcla √∫nica que t√∫ mismo ayudaste a transportar en tus barcos siglos atr√°s.`, p: `Busca en las pinturas alg√∫n elemento que te recuerde a la riqueza del ¬¥pasado (como el color de la tierra, el trabajo manual) y t√≥male una fotograf√≠a` },
            { n: "Mar de Filipinas", d: `Proximamente`, p: `Proximamente` },
            { n: "Estrecho de San Bernardino", d: `Proximamente`, p: `Proximamente` },
            { n: "Puerto de Manila", d: `Proximamente`, p: `Proximamente` },
        ]
    };

    // --- 4. FUNCIONES DE INTERFAZ Y MAPA ---
  function accesoRol(rol) {
        const pass = prompt(`Ingrese la contrase√±a de acceso para el perfil de ${rol}:`);
        if (pass === LLAVES_ACCESO[rol]) {
            rolActivo = rol;
            salaActual = 1;
            rutaActual = (rol === "Cart√≥grafo" || rol === "Comerciante") ? [...rutaBase].reverse() : [...rutaBase];
            
            document.getElementById('menu-roles').style.display = 'none';
            document.getElementById('panel-datos').style.display = 'flex';
            document.getElementById('rol-nombre').innerText = rol.toUpperCase();
            
            // Inyectamos el ID en el HTML
            document.getElementById('id-viajero-display').innerText = viajeroID;
            
            setTimeout(initMap, 100);
        } else { 
            alert("Contrase√±a incorrecta. El Archivo Real permanece cerrado."); 
        }
    }

    function initMap() {
        if (map) map.remove(); 
        map = L.map('map', { zoomControl: false }).setView([20, 180], 3);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        document.getElementById('map').style.filter = "sepia(0.3) hue-rotate(185deg) brightness(0.9)";
        
        // Forzar redibujado para evitar pantalla azul
        setTimeout(() => { map.invalidateSize(); }, 200);
        renderPoint(1);
    }

    function renderPoint(id) {
        const hito = rutaActual[id-1];
        const info = baseDeDatos[rolActivo][id-1];
        const marker = L.marker(hito.c).addTo(map);
        
        marker.on('click', () => {
            document.getElementById('nombre-hito').innerText = info.n;
            document.getElementById('info-dato').innerText = info.d;
            document.getElementById('info-pregunta').innerText = info.p;
            document.getElementById('btn-next').style.display = 'block';
            document.getElementById('sala-tag').innerText = `Sala ${id}/15`;
            map.flyTo(hito.c, 4);
            cargarComentarios(info.n);
        });

        if (id > 1) {
            L.polyline([rutaActual[id-2].c, hito.c], { color: '#1b2631', weight: 3, dashArray: '8, 12', opacity: 0.6 }).addTo(map);
        }
    }

    function siguienteSala() {
        if (salaActual < 15) {
            salaActual++;
            renderPoint(salaActual);
            document.getElementById('btn-next').style.display = 'none';
        }
    }
    let puntoActualParaBitacora = "";

	// --- ACTIVAR BOT√ìN TRAS CONTRASE√ëA ---
function accesoRol(rol) {
    const pass = prompt(`Ingrese la contrase√±a para ${rol}:`);
    if (pass === LLAVES_ACCESO[rol]) {
        rolActivo = rol; // Guardamos el oficio
        salaActual = 1;
        rutaActual = (rol === "Cart√≥grafo" || rol === "Comerciante") ? [...rutaBase].reverse() : [...rutaBase];
        
        document.getElementById('menu-roles').style.display = 'none';
        document.getElementById('panel-datos').style.display = 'flex';
        
        // MOSTRAR EL BOT√ìN AZUL (Ahora s√≠)
        const btn = document.getElementById('btn-bitacora-global');
        if(btn) btn.style.display = 'block';

        setTimeout(initMap, 100);
    } else {
        alert("Contrase√±a incorrecta.");
    }
}

// --- ABRIR GALER√çA PROPIA DEL DATO/OFICIO ---
function abrirBitacoraCompartida() {
    const modal = document.getElementById('modal-bitacora');
    const lista = document.getElementById('lista-comentarios-modal');
    const hitoActual = document.getElementById('nombre-hito').innerText;

    if (!hitoActual || hitoActual === "Hito") return alert("Selecciona un punto primero.");

    modal.style.display = "block";
    lista.innerHTML = "<p style='text-align:center;'>Buscando bit√°coras de " + rolActivo + "...</p>";

    fetch(APPS_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
        // FILTRADO DOBLE: Por el Punto Y por el Rol (Oficio)
        const filtrados = data.filter(d => d.punto === hitoActual && d.rol === rolActivo);
        
        if (filtrados.length === 0) {
            lista.innerHTML = `<p style='text-align:center; padding:20px;'>Nadie del gremio de <b>${rolActivo}s</b> ha dejado evidencias aqu√≠.</p>`;
            return;
        }

        lista.innerHTML = filtrados.map(d => `
            <div class="comentario-item" style="background:white; padding:15px; border-radius:10px; margin-bottom:15px; border-left: 5px solid #5dade2;">
                <small style="color:#7f8c8d;">ID: ${d.id}</small>
                <p style="margin:8px 0;">${d.texto}</p>
                ${crearElementoMultimedia(d.archivo)}
            </div>
        `).join("");
    })
    .catch(() => lista.innerHTML = "Error al conectar con el Archivo Real.");
}

function cerrarBitacora() {
    document.getElementById('modal-bitacora').style.display = "none";
}


    // --- 5. SISTEMA DE COMENTARIOS Y APPS SCRIPT ---
   function cargarComentarios(punto) {
    const lista = document.getElementById('lista-comentarios');
    lista.innerHTML = "<em>Buscando en los archivos reales...</em>";
    
    fetch(APPS_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
        const filtrados = data.filter(d => d.punto === punto);
        if (filtrados.length === 0) {
            lista.innerHTML = "<em>Sin hallazgos en este punto todav√≠a.</em>";
            return;
        }

        // Construimos la lista asegurando que el multimedia se procese
        let htmlFinal = "";
        filtrados.forEach(d => {
            htmlFinal += `
                <div class="comentario-item">
                    <strong>${d.rol}:</strong> ${d.texto}
                    ${crearElementoMultimedia(d.archivo)} 
                </div>
            `;
        });
        lista.innerHTML = htmlFinal;
    })
    .catch(err => {
        console.error("Error al cargar:", err);
        lista.innerHTML = "<em>El Archivo Real no responde. Revisa la conexi√≥n.</em>";
    });
}

   function crearElementoMultimedia(url) {
    // Si no hay URL o es el texto por defecto, no pongas nada
    if (!url || url === "Sin archivo" || url.includes("Error") || url.trim() === "") return "";

    // Extraer el ID de Google Drive del enlace
    let idDrive = "";
    if (url.includes("id=")) {
        idDrive = url.split("id=")[1].split("&")[0];
    } else if (url.includes("/d/")) {
        idDrive = url.split("/d/")[1].split("/")[0];
    }

    if (!idDrive) return "";

    // Link para visualizaci√≥n directa
    const directUrl = `https://lh3.googleusercontent.com/d/${idDrive}`;

    // PROTECCI√ìN PARA IMAGEN
    const htmlImagen = `
        <div style="position:relative; user-select:none; margin-top:10px; border:1px solid #ddd; border-radius:8px; overflow:hidden;">
            <img src="${directUrl}" style="width:100%; display:block;" oncontextmenu="return false;">
            <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:transparent;"></div>
        </div>`;

    // PROTECCI√ìN PARA AUDIO
    const htmlAudio = `
        <div style="margin-top:10px;">
            <audio controls controlsList="nodownload" oncontextmenu="return false;" style="width:100%;">
                <source src="https://docs.google.com/uc?export=download&id=${idDrive}" type="audio/mpeg">
                Tu navegador no soporta este audio.
            </audio>
        </div>`;

    // Si el nombre del archivo o la URL sugieren audio, mostramos el reproductor
    return (url.toLowerCase().match(/(audio|mp3|wav|m4a|ogg)/)) ? htmlAudio : htmlImagen;
}

    // --- 4. ENV√çO DE REPORTES ---
    function actualizarStatusArchivo() {
        const file = document.getElementById('archivo-oculto').files[0];
        const status = document.getElementById('status-archivo');
        if (file) { status.innerText = "üìé Listo para sellar: " + file.name; }
    }

    async function enviarReporte() {
        const texto = document.getElementById('texto-bitacora').value;
        const inputArchivo = document.getElementById('archivo-oculto');
        const archivo = inputArchivo.files[0];
        const hitoNombre = baseDeDatos[rolActivo][salaActual - 1].n;

        if (!texto.trim() && !archivo) {
            alert("Navegante, debes escribir algo o adjuntar una evidencia.");
            return;
        }

        let payload = {
            idVisitante: viajeroID,
            rol: rolActivo,
            punto: hitoNombre,
            texto: texto,
            archivoB64: null,
            tipoMime: null,
            nombreArchivo: null
        };

        if (archivo) {
            const reader = new FileReader();
            const base64Promise = new Promise((resolve) => {
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(archivo);
            });
            payload.archivoB64 = await base64Promise;
            payload.tipoMime = archivo.type;
            payload.nombreArchivo = archivo.name;
        }
        enviarFetch(payload);
    }

    // ... funciones de env√≠o ...
    function enviarFetch(payload) {
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        })
        .then(() => {
            alert("‚úÖ Reporte sellado con √©xito.");
            document.getElementById('texto-bitacora').value = "";
            document.getElementById('archivo-oculto').value = "";
            if(document.getElementById('status-archivo')) document.getElementById('status-archivo').innerText = "";
        })
        .catch(err => alert("Error de conexi√≥n."));
    }
</script>